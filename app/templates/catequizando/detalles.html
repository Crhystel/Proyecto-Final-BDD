<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Catequizandos</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 40px 20px;
            font-family: 'Poppins', sans-serif;
            background: 
                linear-gradient(rgba(255, 240, 245, 0.9), rgba(255, 245, 250, 0.95)),
                url('https://wallpapers.com/images/featured/pink-aesthetic-tumblr-laptop-yb2mef7h48w9j760.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #4a148c;
            min-height: 100vh;
        }

        /* === CONTENEDOR Y TÍTULOS === */
        .container { max-width: 900px; margin: auto; }
        h1 {
            color: #6a1b9a;
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            color: #8e44ad;
            border-bottom: 2px solid #f3e5f5;
            padding-bottom: 10px;
            font-size: 22px;
        }
        h3 {
            margin-top: 30px;
            color: #7b1fa2;
            font-size: 18px;
        }

        /* === TARJETA DE SECCIÓN === */
        .section-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: left;
        }

        /* === TABLAS === */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #eee;
            vertical-align: middle;
        }
        thead th {
            background-color: #f9f2ff;
            font-weight: 600;
            color: #6a1b9a;
        }
        form { margin-top: 20px; }
        .form-section { border-top: 1px solid #eee; padding-top: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #7b1fa2; font-size: 14px; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
        }
        textarea { resize: vertical; min-height: 80px; }
        
        /* === BOTONES === */
        .boton-principal, button[type="submit"] {
            display: inline-block;
            background-color: #8e44ad;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .boton-principal:hover, button[type="submit"]:hover { background-color: #6a1b9a; }
        
        .boton-regreso {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 18px;
            background-color: #bab3bd;
            color: white;
            text-decoration: none;
            border-radius: 8px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            padding: 6px 10px;
            font-size: 12px;
        }
        .delete-btn:hover { background-color: #c0392b; }
  </style>
</head>
<body>
 <div class="container">
    <h1>Gestionar a: {{ catequizando.nombre }} {{ catequizando.apellido }}</h1>
    <a href="{{ url_for('catequizando.index') }}" class="boton-regreso">← Volver a la lista</a>
    <hr>

    <!-- 1. Sección de Datos Principales (con campos no editables) -->
    <div class="section-card">
        <h2>Datos Principales y Ficha</h2>
        <div class="form-grid">
            <div class="info-field"><strong>ID:</strong> {{ catequizando._id }}</div>
            <div class="info-field"><strong>Documento de Identidad:</strong> {{ catequizando.documento_identidad or 'N/A' }}</div>
            <div class="info-field"><strong>Fecha de Registro:</strong> {{ catequizando.fecha_registro.strftime('%d/%m/%Y') if catequizando.fecha_registro else 'N/A' }}</div>
        </div>
        <hr>
        <form method="post" action="{{ url_for('catequizando.actualizar_datos_principales', id=catequizando._id) }}">
            <div class="form-grid">
                <div><label>Nombre:</label> <input name="nombre" value="{{ catequizando.nombre }}"></div>
                <div><label>Apellido:</label> <input name="apellido" value="{{ catequizando.apellido }}"></div>
                <div>
                    <label>Fecha Nacimiento:</label> 
                    <input type="date" name="fecha_nacimiento" value="{{ catequizando.fecha_nacimiento.strftime('%Y-%m-%d') if catequizando.fecha_nacimiento else '' }}">
                </div>
                <div>
                    <label>Parroquia de Registro:</label>
                    <select name="parroquia_ref">
                        <option value="">-- Sin parroquia --</option>
                        {% for p in todas_las_parroquias %}<option value="{{ p._id }}" {% if p._id == catequizando.parroquia_ref %}selected{% endif %}>{{ p.nombre }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            <hr>
            <h4>Ficha de Bautismo</h4>
            <label><input type="checkbox" name="tiene_bautismo" {% if catequizando.tiene_bautismo %}checked{% endif %}> ¿Está bautizado?</label>
            <div class="form-grid">
                <div><label>Lugar de Bautismo:</label> <input name="lugar_bautismo" value="{{ catequizando.lugar_bautismo or '' }}"></div>
                <div><label>Fecha de Bautismo:</label> <input type="date" name="fecha_bautismo" value="{{ catequizando.fecha_bautismo.strftime('%Y-%m-%d') if catequizando.fecha_bautismo else '' }}"></div>
            </div>
            <button type="submit">Guardar Cambios Principales</button>
        </form>
    </div>

    <!-- 2. Sección de Documentos -->
    <div class="section-card">
        <h2>Documentos Digitales</h2>
        <table>
            <thead><tr><th>ID</th><th>Tipo</th><th>Descripción</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for doc in catequizando.documentos or [] %}
                <tr>
                    <td>{{ doc._id }}</td>
                    <td>{{ doc.tipo }}</td>
                    <td>{{ doc.descripcion }}</td>
                    <td>
                        <a href="{{ doc.ruta_archivo }}" target="_blank">Ver</a>
                        <form method="post" style="display:inline;" action="{{ url_for('catequizando.eliminar_un_documento', id_catequizando=catequizando._id, id_documento=doc._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="4">No hay documentos registrados.</td></tr>{% endfor %}
            </tbody>
        </table>
        <form method="post" action="{{ url_for('catequizando.agregar_un_documento', id=catequizando._id) }}">
            <h3>Añadir Documento</h3>
            <div class="form-grid">
                <select name="tipo_documento" required><option value="">-- Tipo --</option>{% for td in todos_los_tipos_doc %}<option value="{{ td.codigo }}">{{ td.nombre }}</option>{% endfor %}</select>
                <input type="text" name="descripcion_documento" placeholder="Descripción (ej. Fe de Bautismo)" required>
            </div>
            <input type="file" name="archivo_documento" required> <!-- La lógica de subida debe implementarse en el backend -->
            <button type="submit">Añadir</button>
        </form>
    </div>

    <!-- 3. Sección de Inscripciones (Ampliada) -->
    <div class="section-card">
        <h2>Inscripciones</h2>
        <table>
            <thead><tr><th>ID</th><th>Fecha</th><th>Grupo</th><th>Estado Pago</th><th>Observaciones</th><th>Certificado</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for insc in catequizando.inscripciones or [] %}
                <tr>
                    <td>{{ insc._id }}</td>
                    <td>{{ insc.fecha_inscripcion.strftime('%d/%m/%Y') if insc.fecha_inscripcion else 'N/A' }}</td>
                    <td>Grupo #{{ insc.grupo_ref }}</td>
                    <td>{{ 'Pagado' if insc.estado_pago == 'P' else 'Debe' }}</td>
                    <td>{{ insc.observaciones or '—' }}</td>
                    <td>
                        {% if insc.certificado %}
                            <a href="#" title="Emitido: {{insc.certificado.fecha_emision.strftime('%d/%m/%Y')}}">Ver #{{ insc.certificado.id_certificado }}</a>
                        {% else %}
                            <button>Generar</button>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="{{ url_for('catequizando.eliminar_una_inscripcion', id_catequizando=catequizando._id, id_inscripcion=insc._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="7">No hay inscripciones.</td></tr>{% endfor %}
            </tbody>
        </table>
        <!-- Formulario de inscripción sin cambios -->
    </div>
    
    <!-- 4. Progresos Académicos (Ampliada) -->
    <div class="section-card">
        <h2>Progresos Académicos</h2>
        <table>
            <thead><tr><th>ID</th><th>Nivel</th><th>Intento</th><th>Aprobado</th><th>Fecha Fin</th><th>Autorización</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for prog in catequizando.progresos or [] %}
                <tr>
                    <td>{{ prog._id }}</td>
                    <td>Nivel #{{ prog.nivel_ref }}</td>
                    <td>{{ prog.intento }}</td>
                    <td>{{ 'Sí' if prog.aprobado else 'No' }}</td>
                    <td>{{ prog.fecha_fin.strftime('%d/%m/%Y') if prog.fecha_fin else 'En curso' }}</td>
                    <td>{{ prog.autorizacion.motivo if prog.autorizacion else 'N/A' }}</td>
                    <td>
                        <form method="post" action="{{ url_for('catequizando.eliminar_un_progreso', id_catequizando=catequizando._id, id_progreso=prog._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="7">No hay progresos registrados.</td></tr>{% endfor %}
            </tbody>
        </table>
        <!-- Formulario de progreso sin cambios -->
    </div>
    
    <!-- 5. Asistencias (Ampliada) -->
    <div class="section-card">
        <h2>Asistencias</h2>
        <table>
            <thead><tr><th>Fecha</th><th>Estado</th><th>Nivel</th><th>Grupo</th><th>Registró (Catequista)</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for asis in catequizando.asistencias or [] %}
                <tr>
                    <td>{{ asis.fecha.strftime('%d/%m/%Y') if asis.fecha else 'N/A' }}</td>
                    <td>{{ {'A':'Asistió', 'F':'Faltó', 'J':'Justificado'}.get(asis.estado, 'N/A') }}</td>
                    <td>Nivel #{{ asis.nivel_ref }}</td>
                    <td>Grupo #{{ asis.grupo_ref }}</td>
                    <td>Catequista #{{ asis.catequista_ref }}</td>
                    <td>
                        <form method="post" action="{{ url_for('catequizando.eliminar_una_asistencia', id_catequizando=catequizando._id, id_asistencia=asis._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="6">No hay asistencias registradas.</td></tr>{% endfor %}
            </tbody>
        </table>
        <!-- Formulario de asistencia sin cambios -->
    </div>
    
    <!-- 6. Sesiones Especiales (Ampliada) -->
    <div class="section-card">
        <h2>Sesiones Especiales</h2>
        <table>
            <thead><tr><th>Fecha</th><th>Tipo</th><th>Observaciones</th><th>Autorizado por</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for sesion in catequizando.sesiones_especiales or [] %}
                <tr>
                    <td>{{ sesion.fecha.strftime('%d/%m/%Y') if sesion.fecha else 'N/A' }}</td>
                    <td>{{ sesion.tipo_sesion }}</td>
                    <td>{{ sesion.observaciones }}</td>
                    <td>Usuario #{{ sesion.autorizado_por_ref }}</td>
                    <td>
                        <form method="post" action="{{ url_for('catequizando.eliminar_una_sesion', id_catequizando=catequizando._id, id_sesion=sesion._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="5">No hay sesiones especiales.</td></tr>{% endfor %}
            </tbody>
        </table>
        <!-- Formulario de sesiones sin cambios -->
    </div>
    
    <!-- 7. Sacramentos (Ampliada) -->
    <div class="section-card">
        <h2>Sacramentos Recibidos</h2>
        <table>
            <thead><tr><th>Sacramento</th><th>Fecha</th><th>Lugar</th><th>Observaciones</th><th>Padre</th><th>Madre</th><th>Padrino</th><th>Madrina</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for sac in catequizando.sacramentos or [] %}
                <tr>
                    <td>Sacramento #{{ sac.tipo_sacramento_ref }}</td>
                    <td>{{ sac.fecha_sacramento.strftime('%d/%m/%Y') if sac.fecha_sacramento else 'N/A' }}</td>
                    <td>{{ sac.lugar }}</td>
                    <td>{{ sac.observaciones or '—' }}</td>
                    <td>Padre #{{ sac.padre_ref or 'N/A' }}</td>
                    <td>Madre #{{ sac.madre_ref or 'N/A' }}</td>
                    <td>Padrino #{{ sac.padrino_ref or 'N/A' }}</td>
                    <td>Madrina #{{ sac.madrina_ref or 'N/A' }}</td>
                    <td>
                        <form method="post" action="{{ url_for('catequizando.eliminar_un_sacramento', id_catequizando=catequizando._id, id_sacramento=sac._id) }}">
                            <button type="submit" class="delete-btn">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="9">No hay sacramentos registrados.</td></tr>{% endfor %}
            </tbody>
        </table>
        <!-- Formulario de sacramentos sin cambios -->
    </div>

    <!-- 8. Historial Parroquial (Mejorado) -->
    <div class="section-card">
        <h2>Historial Parroquial</h2>
        <table>
            <thead><tr><th>Parroquia</th><th>Fecha de Inicio</th><th>Fecha de Fin</th></tr></thead>
            <tbody>
                {% for hist in catequizando.historial_parroquial or [] %}
                <tr>
                    <td>Parroquia #{{ hist.parroquia_ref }}</td>
                    <td>{{ hist.fecha_inicio.strftime('%d/%m/%Y') if hist.fecha_inicio else 'N/A' }}</td>
                    <td>{{ hist.fecha_fin.strftime('%d/%m/%Y') if hist.fecha_fin else 'Actual' }}</td>
                </tr>
                {% else %}<tr><td colspan="3">No hay historial.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

</div>
</body>
</html>
